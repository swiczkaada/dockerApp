{% extends "base.html" %}

{% block content %}
  <h2 class="text-3xl font-bold text-center text-blue-900 mb-8">Statistiques Globales</h2>

  <div class="flex flex-wrap gap-6 justify-center mb-12">
    <div class="bg-blue-100 text-blue-900 rounded-lg shadow-md p-6 flex-1 min-w-[200px] max-w-xs text-center">
      <h3 class="text-xl font-semibold mb-2">Total QR Codes</h3>
      <p class="text-2xl font-bold">{{ total_qrcodes }}</p>
    </div>
    <div class="bg-blue-100 text-blue-900 rounded-lg shadow-md p-6 flex-1 min-w-[200px] max-w-xs text-center">
      <h3 class="text-xl font-semibold mb-2">Total Scans</h3>
      <p class="text-2xl font-bold">{{ total_scans }}</p>
    </div>
    <div class="bg-blue-100 text-blue-900 rounded-lg shadow-md p-6 flex-1 min-w-[200px] max-w-xs text-center">
      <h3 class="text-xl font-semibold mb-2">Moyenne quotidienne des scans (30 derniers jours)</h3>
      <p class="text-2xl font-bold">{{ avg_daily_scans|floatformat:2 }}</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-10 max-w-7xl mx-auto">
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h3 class="text-lg font-semibold mb-4 text-blue-800 text-center">Répartition des scans par jour (30 derniers jours)</h3>
      <canvas id="scansByDayChart" class="w-full h-72"></canvas>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h3 class="text-lg font-semibold mb-4 text-blue-800 text-center">Répartition des scans par mois (6 derniers mois)</h3>
      <canvas id="scansByMonthChart" class="w-full h-72"></canvas>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h3 class="text-lg font-semibold mb-4 text-blue-800 text-center">Top 5 des QR Codes les plus scannés</h3>
      <canvas id="topQRCodesChart" class="w-full h-72"></canvas>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h3 class="text-lg font-semibold mb-4 text-blue-800 text-center">Distribution des scans par heure de la journée</h3>
      <canvas id="scansByHourChart" class="w-full h-72"></canvas>
    </div>

    <!-- Full width donut chart centered -->
    <div class="bg-white p-6 rounded-lg shadow-lg col-span-full max-w-md mx-auto">
      <h3 class="text-lg font-semibold mb-6 text-blue-800 text-center">QR Codes actifs vs inactifs</h3>
      <div class="flex justify-center">
        <canvas id="qrcodeActiveChart" class="w-64 h-64"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels30Days = {{ labels_30_days|safe }};
    const data30Days = {{ data_30_days|safe }};

    const labels6Months = {{ labels_6_months|safe }};
    const data6Months = {{ data_6_months|safe }};

    const topQRCodesLabels = {{ top_qrcodes_labels|safe }};
    const topQRCodesData = {{ top_qrcodes_data|safe }};

    const hoursLabels = {{ hours_labels|safe }};
    const scansByHourData = {{ scans_by_hour_data|safe }};

    const activeCount = {{ active_count }};
    const inactiveCount = {{ inactive_count }};

    new Chart(document.getElementById('scansByDayChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: labels30Days,
        datasets: [{
          label: 'Scans par jour',
          data: data30Days,
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: { scales: { y: { beginAtZero: true } }, responsive: true }
    });

    new Chart(document.getElementById('scansByMonthChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: labels6Months,
        datasets: [{
          label: 'Scans par mois',
          data: data6Months,
          backgroundColor: 'rgba(255, 159, 64, 0.6)',
          borderColor: 'rgba(255, 159, 64, 1)',
          borderWidth: 2,
          fill: false,
          tension: 0.3
        }]
      },
      options: { scales: { y: { beginAtZero: true } }, responsive: true }
    });

    new Chart(document.getElementById('topQRCodesChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: topQRCodesLabels,
        datasets: [{
          label: 'Nombre de scans',
          data: topQRCodesData,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: { scales: { y: { beginAtZero: true } }, responsive: true }
    });

    new Chart(document.getElementById('scansByHourChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: hoursLabels,
        datasets: [{
          label: 'Scans par heure',
          data: scansByHourData,
          backgroundColor: 'rgba(153, 102, 255, 0.6)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true },
          x: { title: { display: true, text: 'Heure (0-23)' } }
        },
        responsive: true
      }
    });

    new Chart(document.getElementById('qrcodeActiveChart').getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Actifs', 'Inactifs'],
        datasets: [{
          data: [activeCount, inactiveCount],
          backgroundColor: [
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 99, 132, 0.7)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        cutout: '60%',
        animation: {
          animateRotate: true,
          animateScale: true
        },
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  </script>
{% endblock %}
